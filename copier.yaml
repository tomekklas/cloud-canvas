# copier.yml

_min_copier_version: 8.3.0

_exclude:
  - notes.txt
  - .git*
  - copier.yaml

_jinja_extensions:
    - jinja2_slug.SlugExtension
    - jinja2_time.TimeExtension

# Constants
TEMPLATE_VERSION:
  type: str
  when: false
  default: v0.1

PRODUCT_VERSION:
  type: str
  when: false
  default: v1

ARTEFACT_BUCKET: # TODO: ask for test and prod buckets? generate when does not exist?
  type: str
  when: false
  default: deployment-idea-test-bucket

# Questionnaire
module_name:
  type: str
  help: Choose a descriptive name for the module.
  validator: >-
      {% if not (module_name | regex_search('^(?! *$)(?!deployment$).+$')) %}
      Module name can not start or end with a space. "Deployment" word is reserved and can not be used.
      {% endif %}

# TODO: on re-generatin this remembers previous invokation value, not current one 
module_directory_name:
  type: str
  default: "{{ module_name | replace(' ', '-') | regex_replace('[^a-zA-Z0-9-]', '') | lower }}"
  help: Please provide module directory name (suggested based on previous answer)
  # TODO: add validator

short_module_description:
  type: str
  help: Please provide short module description (press Enter to skip)
  default: ""

include_lambda_scaffolding:
  help: Would you like to include lambda functions scaffolding?
  choices:
    - Yes
    - No
  default: No

lambda_names:
  type: str
  when: "{{ include_lambda_scaffolding == True }}"
  help: Please list your lambda names separated by commas.
  # TODO: add validator
    # deduplicate names

include_common_lambda_layer:
  help: Would you like to common lambda layer?
  when: "{{ include_lambda_scaffolding == True }}"
  choices:
    - Yes
    - No
  default: Yes

common_lambda_layer_name: # TODO: make sure it can be used as a directory name
  type: str
  when: "{{ include_lambda_scaffolding == True and include_common_lambda_layer == True }}"
  help: Please provide name of the lambda layer function.
  # TODO: add validator

add_deployment_setup:
  help: Would you like to add scaffolding of deployment setup?
  # TODO: add validator
  choices:
    - Yes
    - No
  default: Yes

owner_name:
  type: str
  help: Please provide name of the project owner name (press Enter to skip)
  default: ""

owner_email:
  type: str
  help: Please provide name of the project owner email (press Enter to skip)
  default: ""
  # TODO: add validator


_message_before_copy: |
    Thank you for generating a project using Cloud Canvas.

    You'll be asked a series of questions whose answers will be used to
    generate a tailored project for you.

    If modules need to be added at later date, just re-run this command.

_message_after_copy: |
    Your project "{{ _copier_conf.dst_path }}" has been created successfully!

    Next steps:

    1. Change directory to the project root:

       $ cd {{ _copier_conf.dst_path }}

    2. Read "CONTRIBUING.md" and start coding.

_tasks:
  - >-
    # generate lambda directories from blueprint
    {% if lambda_names %}
      {% set lambda_list = lambda_names.split(",") %}
      {% for lambda_name in lambda_list %}
        cp -rf {{ module_directory_name }}/lambda/functions/blueprint {{ module_directory_name }}/lambda/functions/{{ lambda_name|trim|slug }}
      {% endfor %}
    {% endif %}
  - >-
    chmod +x codebuild_build.sh


